# try-xinput-keybd-rust

## 1. 目的 / ゴール

本リポジトリは **Windows + Rust (MSVC)** 環境において、

* Xbox 互換ゲームコントローラの **XInput ボタン入力** を取得し
* それを **Win32 SendInput によりキーボード入力へ変換**
* **ボタン押し続け = キー長押し** として OS / アプリケーションから正しく認識させる

ことを最小構成で実証・学習するための **検証用常駐ツール**である。

AntiMicroX / JoyToKey 等が苦手とする「疑似長押し」ではなく、
**状態遷移に基づいた本物の KeyDown / KeyUp 制御**を主眼とする。

---

## 2. 非ゴール（今回やらないこと）

以下は本検証では対象外とする。

* 複数ボタン同時対応
* トグル / レイヤー / マクロ
* 連打・オートリピート
* UI（GUI / Tray）
* 仮想 HID / ViGEm
* フック / DLL 注入

※ あくまで **Win32 API + Rust に慣れるための最小仕様**とする。

---

## 3. 想定ユースケース

* Rust + Win32 API（XInput / SendInput）の学習
* 入力状態管理（FSM）の理解
* ゲーム・一般アプリ双方での「キー長押し」挙動の確認
* 管理者権限あり / なしでの SendInput 挙動差分確認

---

## 4. 対応環境

| 項目   | 内容                         |
| ---- | -------------------------- |
| OS   | Windows 10 / 11 (x64)      |
| Rust | stable (MSVC toolchain)    |
| 入力   | XInput 対応ゲームパッド（Xbox 互換）   |
| 出力   | Win32 SendInput (Keyboard) |
| 配布形式 | 単体 `.exe`                  |

---

## 5. 機能仕様

### 5.1 入力仕様（XInput）

* `XInputGetState` により **ポーリング方式**で状態取得
* 対象コントローラ：`UserIndex = 0`
* 対象入力：**1 ボタンのみ**（例：`XINPUT_GAMEPAD_A`）
* ポーリング周期：5ms 前後（調整可）

---

### 5.2 出力仕様（キーボード）

* `SendInput` を使用
* 対象キー：**1 キーのみ**（例：`VK_SPACE`）
* ScanCode は使用せず Virtual-Key ベース

#### キーイベント方針（重要）

| 状態      | 送信内容                   |
| ------- | ---------------------- |
| ボタン押下開始 | `KeyDown` を **1回のみ送信** |
| 押し続け    | **何も送信しない**            |
| ボタン解放   | `KeyUp` を **1回のみ送信**   |

※ `KeyDown` を連打しないことが本ツールの核心である。

---

## 6. 状態管理（FSM）

### 6.1 状態定義

```text
ButtonState:
  - Released
  - Pressed
```

### 6.2 状態遷移と動作

| 前回       | 今回       | 動作                 |
| -------- | -------- | ------------------ |
| Released | Pressed  | SendInput(KeyDown) |
| Pressed  | Pressed  | 何もしない              |
| Pressed  | Released | SendInput(KeyUp)   |
| Released | Released | 何もしない              |

この FSM により、
**OS / アプリケーションからは「本物のキー長押し」として観測される。**

---

## 7. 実行形態

### 7.1 常駐実行

* コンソールアプリとして起動
* 明示的な終了操作があるまでループ継続
* バックグラウンド常駐を前提

### 7.2 管理者権限での検証

* 通常ユーザー権限での起動
* **管理者権限（Run as Administrator）での起動**

両方を試し、以下を確認する：

* SendInput がどのプロセスに有効か
* UIPI による入力制限の挙動

---

## 8. セキュリティ・制約事項

* SendInput は **管理者権限プロセスには注入できない場合がある**
* 一部ゲーム・アプリでは Raw Input / Anti-cheat により無効化される可能性がある
* 本ツールは **入力補助・学習用途のみ**を想定

---

## 9. 技術スタック

### 9.1 Rust クレート

* `windows-sys`

  * Win32 API 生バインディング
  * unsafe 境界を明示的に扱う

### 9.2 設計方針

* unsafe は Win32 呼び出し部に限定
* 状態管理（FSM）は safe Rust で完結
* 1 ファイル構成から開始し、後続で分割可能

---

## 10. 将来拡張（次フェーズ候補）

* ボタン → キーのテーブル化
* 複数ボタン対応
* トリガー（アナログ → 閾値）
* スティック → WASD
* モジュール分割（input / mapper / output）
* 設定ファイル（TOML / JSON）

※ 本 spec.md は **最小検証完了後に更新される前提**とする。

---

## 11. 成功条件（Done Definition）

* [ ] XInput ボタンを押すと KeyDown が1回だけ送信される
* [ ] 押し続けている間、キーが押下状態として維持される
* [ ] ボタンを離すと KeyUp が送信される
* [ ] 一般アプリでキー長押しが認識される
* [ ] 管理者権限起動でも挙動を確認できる

---

## 12. 備考

本リポジトリは **実験・学習目的**であり、
市販ツールや既存 OSS の代替を目的としない。
